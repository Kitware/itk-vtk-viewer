"use strict";var utils=require("./../utils"),settle=require("./../core/settle"),buildFullPath=require("../core/buildFullPath"),buildURL=require("./../helpers/buildURL"),http=require("http"),https=require("https"),httpFollow=require("follow-redirects").http,httpsFollow=require("follow-redirects").https,url=require("url"),zlib=require("zlib"),VERSION=require("./../env/data").version,createError=require("../core/createError"),enhanceError=require("../core/enhanceError"),defaults=require("../defaults"),Cancel=require("../cancel/Cancel"),isHttps=/https:?/;function setProxy(e,t,r){if(e.hostname=t.host,e.host=t.host,e.port=t.port,e.path=r,t.auth){var o=Buffer.from(t.auth.username+":"+t.auth.password,"utf8").toString("base64");e.headers["Proxy-Authorization"]="Basic "+o}e.beforeRedirect=function(e){e.headers.host=e.host,setProxy(e,t,e.href)}}module.exports=function(e){return new Promise((function(t,r){var o;function a(){e.cancelToken&&e.cancelToken.unsubscribe(o),e.signal&&e.signal.removeEventListener("abort",o)}var n=function(e){a(),t(e)},s=function(e){a(),r(e)},i=e.data,u=e.headers,c={};if(Object.keys(u).forEach((function(e){c[e.toLowerCase()]=e})),"user-agent"in c?u[c["user-agent"]]||delete u[c["user-agent"]]:u["User-Agent"]="axios/"+VERSION,i&&!utils.isStream(i)){if(Buffer.isBuffer(i));else if(utils.isArrayBuffer(i))i=Buffer.from(new Uint8Array(i));else{if(!utils.isString(i))return s(createError("Data after transformation must be a string, an ArrayBuffer, a Buffer, or a Stream",e));i=Buffer.from(i,"utf-8")}c["content-length"]||(u["Content-Length"]=i.length)}var l=void 0;e.auth&&(l=(e.auth.username||"")+":"+(e.auth.password||""));var h=buildFullPath(e.baseURL,e.url),p=url.parse(h),f=p.protocol||"http:";if(!l&&p.auth){var d=p.auth.split(":");l=(d[0]||"")+":"+(d[1]||"")}l&&c.authorization&&delete u[c.authorization];var m=isHttps.test(f),g=m?e.httpsAgent:e.httpAgent,v={path:buildURL(p.path,e.params,e.paramsSerializer).replace(/^\?/,""),method:e.method.toUpperCase(),headers:u,agent:g,agents:{http:e.httpAgent,https:e.httpsAgent},auth:l};e.socketPath?v.socketPath=e.socketPath:(v.hostname=p.hostname,v.port=p.port);var E,b=e.proxy;if(!b&&!1!==b){var x=f.slice(0,-1)+"_proxy",T=process.env[x]||process.env[x.toUpperCase()];if(T){var y=url.parse(T),R=process.env.no_proxy||process.env.NO_PROXY,P=!0;if(R&&(P=!R.split(",").map((function(e){return e.trim()})).some((function(e){return!!e&&("*"===e||"."===e[0]&&p.hostname.substr(p.hostname.length-e.length)===e||p.hostname===e)}))),P&&(b={host:y.hostname,port:y.port,protocol:y.protocol},y.auth)){var q=y.auth.split(":");b.auth={username:q[0],password:q[1]}}}}b&&(v.headers.host=p.hostname+(p.port?":"+p.port:""),setProxy(v,b,f+"//"+p.hostname+(p.port?":"+p.port:"")+v.path));var B=m&&(!b||isHttps.test(b.protocol));e.transport?E=e.transport:0===e.maxRedirects?E=B?https:http:(e.maxRedirects&&(v.maxRedirects=e.maxRedirects),E=B?httpsFollow:httpFollow),e.maxBodyLength>-1&&(v.maxBodyLength=e.maxBodyLength),e.insecureHTTPParser&&(v.insecureHTTPParser=e.insecureHTTPParser);var C=E.request(v,(function(t){if(!C.aborted){var r=t,o=t.req||C;if(204!==t.statusCode&&"HEAD"!==o.method&&!1!==e.decompress)switch(t.headers["content-encoding"]){case"gzip":case"compress":case"deflate":r=r.pipe(zlib.createUnzip()),delete t.headers["content-encoding"]}var a={status:t.statusCode,statusText:t.statusMessage,headers:t.headers,config:e,request:o};if("stream"===e.responseType)a.data=r,settle(n,s,a);else{var i=[],u=0;r.on("data",(function(t){i.push(t),u+=t.length,e.maxContentLength>-1&&u>e.maxContentLength&&(r.destroy(),s(createError("maxContentLength size of "+e.maxContentLength+" exceeded",e,null,o)))})),r.on("error",(function(t){C.aborted||s(enhanceError(t,e,null,o))})),r.on("end",(function(){var t=Buffer.concat(i);"arraybuffer"!==e.responseType&&(t=t.toString(e.responseEncoding),e.responseEncoding&&"utf8"!==e.responseEncoding||(t=utils.stripBOM(t))),a.data=t,settle(n,s,a)}))}}}));if(C.on("error",(function(t){C.aborted&&"ERR_FR_TOO_MANY_REDIRECTS"!==t.code||s(enhanceError(t,e,null,C))})),e.timeout){var L=parseInt(e.timeout,10);if(isNaN(L))return void s(createError("error trying to parse `config.timeout` to int",e,"ERR_PARSE_TIMEOUT",C));C.setTimeout(L,(function(){C.abort();var t=e.transitional||defaults.transitional;s(createError("timeout of "+L+"ms exceeded",e,t.clarifyTimeoutError?"ETIMEDOUT":"ECONNABORTED",C))}))}(e.cancelToken||e.signal)&&(o=function(e){C.aborted||(C.abort(),s(!e||e&&e.type?new Cancel("canceled"):e))},e.cancelToken&&e.cancelToken.subscribe(o),e.signal&&(e.signal.aborted?o():e.signal.addEventListener("abort",o))),utils.isStream(i)?i.on("error",(function(t){s(enhanceError(t,e,null,C))})).pipe(C):C.end(i)}))};