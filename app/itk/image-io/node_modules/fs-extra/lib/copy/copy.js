"use strict";const fs=require("graceful-fs"),path=require("path"),mkdirs=require("../mkdirs").mkdirs,pathExists=require("../path-exists").pathExists,utimesMillis=require("../util/utimes").utimesMillis,stat=require("../util/stat");function copy(e,t,i,r){"function"!=typeof i||r?"function"==typeof i&&(i={filter:i}):(r=i,i={}),r=r||function(){},(i=i||{}).clobber=!("clobber"in i)||!!i.clobber,i.overwrite="overwrite"in i?!!i.overwrite:i.clobber,i.preserveTimestamps&&"ia32"===process.arch&&process.emitWarning("Using the preserveTimestamps option in 32-bit node is not recommended;\n\n\tsee https://github.com/jprichardson/node-fs-extra/issues/269","Warning","fs-extra-WARN0001"),stat.checkPaths(e,t,"copy",i,((s,n)=>{if(s)return r(s);const{srcStat:o,destStat:c}=n;stat.checkParentPaths(e,o,t,"copy",(s=>s?r(s):i.filter?handleFilter(checkParentDir,c,e,t,i,r):checkParentDir(c,e,t,i,r)))}))}function checkParentDir(e,t,i,r,s){const n=path.dirname(i);pathExists(n,((o,c)=>o?s(o):c?getStats(e,t,i,r,s):void mkdirs(n,(n=>n?s(n):getStats(e,t,i,r,s)))))}function handleFilter(e,t,i,r,s,n){Promise.resolve(s.filter(i,r)).then((o=>o?e(t,i,r,s,n):n()),(e=>n(e)))}function startCopy(e,t,i,r,s){return r.filter?handleFilter(getStats,e,t,i,r,s):getStats(e,t,i,r,s)}function getStats(e,t,i,r,s){(r.dereference?fs.stat:fs.lstat)(t,((n,o)=>n?s(n):o.isDirectory()?onDir(o,e,t,i,r,s):o.isFile()||o.isCharacterDevice()||o.isBlockDevice()?onFile(o,e,t,i,r,s):o.isSymbolicLink()?onLink(e,t,i,r,s):o.isSocket()?s(new Error(`Cannot copy a socket file: ${t}`)):o.isFIFO()?s(new Error(`Cannot copy a FIFO pipe: ${t}`)):s(new Error(`Unknown file: ${t}`))))}function onFile(e,t,i,r,s,n){return t?mayCopyFile(e,i,r,s,n):copyFile(e,i,r,s,n)}function mayCopyFile(e,t,i,r,s){if(!r.overwrite)return r.errorOnExist?s(new Error(`'${i}' already exists`)):s();fs.unlink(i,(n=>n?s(n):copyFile(e,t,i,r,s)))}function copyFile(e,t,i,r,s){fs.copyFile(t,i,(n=>n?s(n):r.preserveTimestamps?handleTimestampsAndMode(e.mode,t,i,s):setDestMode(i,e.mode,s)))}function handleTimestampsAndMode(e,t,i,r){return fileIsNotWritable(e)?makeFileWritable(i,e,(s=>s?r(s):setDestTimestampsAndMode(e,t,i,r))):setDestTimestampsAndMode(e,t,i,r)}function fileIsNotWritable(e){return 0==(128&e)}function makeFileWritable(e,t,i){return setDestMode(e,128|t,i)}function setDestTimestampsAndMode(e,t,i,r){setDestTimestamps(t,i,(t=>t?r(t):setDestMode(i,e,r)))}function setDestMode(e,t,i){return fs.chmod(e,t,i)}function setDestTimestamps(e,t,i){fs.stat(e,((e,r)=>e?i(e):utimesMillis(t,r.atime,r.mtime,i)))}function onDir(e,t,i,r,s,n){return t?copyDir(i,r,s,n):mkDirAndCopy(e.mode,i,r,s,n)}function mkDirAndCopy(e,t,i,r,s){fs.mkdir(i,(n=>{if(n)return s(n);copyDir(t,i,r,(t=>t?s(t):setDestMode(i,e,s)))}))}function copyDir(e,t,i,r){fs.readdir(e,((s,n)=>s?r(s):copyDirItems(n,e,t,i,r)))}function copyDirItems(e,t,i,r,s){const n=e.pop();return n?copyDirItem(e,n,t,i,r,s):s()}function copyDirItem(e,t,i,r,s,n){const o=path.join(i,t),c=path.join(r,t);stat.checkPaths(o,c,"copy",s,((t,a)=>{if(t)return n(t);const{destStat:p}=a;startCopy(p,o,c,s,(t=>t?n(t):copyDirItems(e,i,r,s,n)))}))}function onLink(e,t,i,r,s){fs.readlink(t,((t,n)=>t?s(t):(r.dereference&&(n=path.resolve(process.cwd(),n)),e?void fs.readlink(i,((t,o)=>t?"EINVAL"===t.code||"UNKNOWN"===t.code?fs.symlink(n,i,s):s(t):(r.dereference&&(o=path.resolve(process.cwd(),o)),stat.isSrcSubdir(n,o)?s(new Error(`Cannot copy '${n}' to a subdirectory of itself, '${o}'.`)):e.isDirectory()&&stat.isSrcSubdir(o,n)?s(new Error(`Cannot overwrite '${o}' with '${n}'.`)):copyLink(n,i,s)))):fs.symlink(n,i,s))))}function copyLink(e,t,i){fs.unlink(t,(r=>r?i(r):fs.symlink(e,t,i)))}module.exports=copy;