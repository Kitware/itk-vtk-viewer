"use strict";const u=require("universalify").fromCallback,path=require("path"),fs=require("graceful-fs"),mkdir=require("../mkdirs"),pathExists=require("../path-exists").pathExists,{areIdentical}=require("../util/stat");function createLink(e,t,r){function s(e,t){fs.link(e,t,(e=>{if(e)return r(e);r(null)}))}fs.lstat(t,((i,n)=>{fs.lstat(e,((i,a)=>{if(i)return i.message=i.message.replace("lstat","ensureLink"),r(i);if(n&&areIdentical(a,n))return r(null);const c=path.dirname(t);pathExists(c,((i,n)=>i?r(i):n?s(e,t):void mkdir.mkdirs(c,(i=>{if(i)return r(i);s(e,t)}))))}))}))}function createLinkSync(e,t){let r;try{r=fs.lstatSync(t)}catch{}try{const t=fs.lstatSync(e);if(r&&areIdentical(t,r))return}catch(e){throw e.message=e.message.replace("lstat","ensureLink"),e}const s=path.dirname(t);return fs.existsSync(s)||mkdir.mkdirsSync(s),fs.linkSync(e,t)}module.exports={createLink:u(createLink),createLinkSync};